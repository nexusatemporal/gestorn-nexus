// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ—„ï¸ GESTOR NEXUS - SCHEMA PRISMA v1.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sistema interno de gestÃ£o comercial/financeira da Nexus Atemporal
// Produtos gerenciados: One Nexus (CRM clÃ­nicas) e Locadoras (gestÃ£o equipamentos)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” AUTENTICAÃ‡ÃƒO E AUTORIZAÃ‡ÃƒO (RBAC)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// UsuÃ¡rios internos do Gestor Nexus (equipe Nexus Atemporal)
model User {
  id              String    @id @default(cuid())
  clerkId         String?   @unique /// ID do Clerk (mantido temporariamente para migraÃ§Ã£o)
  email           String    @unique
  name            String
  avatar          String?
  role            UserRole  @default(VENDEDOR)
  isActive        Boolean   @default(true)
  lastLoginAt     DateTime?

  // Auth prÃ³prio (v2.54.0)
  passwordHash    String?   /// Hash bcrypt da senha
  refreshToken    String?   /// Refresh token atual (para invalidaÃ§Ã£o)

  // Hierarquia (Gestor -> Vendedores)
  gestorId        String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relacionamentos
  gestor              User?            @relation("GestorVendedores", fields: [gestorId], references: [id])
  vendedores          User[]           @relation("GestorVendedores")
  permissions         UserPermission[]
  assignedLeads       Lead[]           @relation("AssignedVendedor")
  assignedClients     Client[]         @relation("AssignedVendedor")
  interactions        Interaction[]
  impersonateLogs     ImpersonateLog[]
  notifications       Notification[]
  chatMessages        ChatMessage[]    @relation("SentMessages")
  aiConversations     AIConversation[]
  calendarEvents      CalendarEvent[]
  googleCalendarToken GoogleCalendarToken?
  auditLogs           AuditLog[]
  createdPayments     Payment[]
  financeTransactions FinanceTransaction[] @relation("FinanceCreator")

  @@index([clerkId])
  @@index([email])
  @@index([role])
  @@index([gestorId])
}

/// Perfis de acesso do sistema
enum UserRole {
  SUPERADMIN      /// Acesso total, gerencia usuÃ¡rios/configuraÃ§Ãµes/integraÃ§Ãµes
  ADMINISTRATIVO  /// Financeiro completo, relatÃ³rios/mÃ©tricas
  GESTOR          /// Gerencia time vendas, performance vendedores/leads
  VENDEDOR        /// Leads/clientes, chat, SEM financeiro
  DESENVOLVEDOR   /// RBAC granular - impersonate SIM, financeiro NÃƒO
}

/// PermissÃµes granulares por usuÃ¡rio
model UserPermission {
  id         String   @id @default(cuid())
  userId     String
  module     Module
  canView    Boolean  @default(false)
  canCreate  Boolean  @default(false)
  canEdit    Boolean  @default(false)
  canDelete  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, module])
  @@index([userId])
}

/// MÃ³dulos do sistema para controle de permissÃ£o
enum Module {
  DASHBOARD
  CLIENTS_ONE_NEXUS
  CLIENTS_LOCADORAS
  LEADS
  FINANCE
  CHAT
  CALENDAR
  SALES_AI
  SETTINGS
  AUDIT_LOG
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ‘¥ CLIENTES E TENANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// Clientes assinantes dos produtos SaaS
model Client {
  id                  String        @id @default(cuid())

  // Dados obrigatÃ³rios
  contactName         String        /// Nome do contato/responsÃ¡vel
  company             String        /// Nome da empresa/clÃ­nica
  cpfCnpj             String        @unique /// CPF ou CNPJ (11 ou 14 dÃ­gitos)
  email               String
  phone               String
  role                ClientRole?   /// Cargo do responsÃ¡vel

  // Dados do produto
  productType         ProductType
  planId              String
  paymentMethod       PaymentMethod? @default(PIX)
  paymentGateway      PaymentGateway? /// Gateway utilizado

  // Status e datas
  status              ClientStatus  @default(EM_TRIAL)
  trialEndsAt         DateTime?     /// Data de fim do trial

  // Relacionamentos
  vendedorId          String
  tenantId            String?       /// ID do tenant (opcional no momento da criaÃ§Ã£o)
  leadId              String?       /// ID do lead de origem (para conversÃ£o)

  // Notas
  notes               String?       @db.Text

  // === DADOS DA CONVERSÃƒO (Handoff Sales â†’ CS/ImplantaÃ§Ã£o) ===
  dealSummary           String?       @db.Text /// Resumo da negociaÃ§Ã£o (texto ou gerado por IA)
  numberOfUsers         Int           @default(1)
  billingCycle          BillingCycle  @default(MONTHLY)
  closedAt              DateTime      @default(now()) @db.Timestamptz
  firstPaymentDate      DateTime?     @db.Timestamptz
  implementationNotes   String?       @db.Text

  // === BILLING LIFECYCLE (v2.40.0) ===
  activeSubscriptionId  String?       @unique /// Subscription ativa (referÃªncia rÃ¡pida)

  // === RASTREABILIDADE ===
  convertedFromLeadId   String?       @unique

  createdAt           DateTime      @default(now()) @db.Timestamptz
  updatedAt           DateTime      @updatedAt @db.Timestamptz

  // Relations
  plan                Plan              @relation(fields: [planId], references: [id])
  vendedor            User              @relation("AssignedVendedor", fields: [vendedorId], references: [id])
  tenant              Tenant?
  payments            Payment[]
  interactions        Interaction[]
  impersonateLogs     ImpersonateLog[]
  chatConversations   ChatConversation[]
  upgradeHistory      UpgradeHistory[]
  calendarEvents      CalendarEvent[]   @relation("ClientCalendarEvents")
  auditLogs           AuditLog[]
  financeTransactions FinanceTransaction[]
  convertedFromLead   Lead?             @relation("ConvertedLead", fields: [convertedFromLeadId], references: [id])
  subscriptions       Subscription[]    /// v2.40.0 - HistÃ³rico de assinaturas

  @@index([productType])
  @@index([status])
  @@index([vendedorId])
  @@index([planId])
  @@index([cpfCnpj])
}

/// Cargo do responsÃ¡vel pelo cliente
enum ClientRole {
  SOCIO_FUNDADOR
  CEO_PRESIDENTE
  VP_CLEVEL
  DIRETOR
  GERENTE
  COORDENADOR
  SUPERVISOR
  ANALISTA
  RECEPCIONISTA
  OUTRO
}

/// Produtos SaaS gerenciados
enum ProductType {
  ONE_NEXUS   /// CRM para clÃ­nicas estÃ©ticas
  LOCADORAS   /// GestÃ£o de locaÃ§Ã£o de equipamentos
}

/// Status do cliente
enum ClientStatus {
  ATIVO         /// Pagamentos em dia
  INADIMPLENTE  /// Pagamento atrasado (atÃ© 30 dias)
  BLOQUEADO     /// Acesso suspenso (30-120 dias)
  CANCELADO     /// Contrato encerrado
  EM_TRIAL      /// PerÃ­odo de teste
}

/// MÃ©todo de pagamento
enum PaymentMethod {
  PIX         /// Via AbacatePay
  CARTAO      /// Via Asaas
  BOLETO      /// Via Asaas
  TRANSFERENCIA
}

/// Ciclo de cobranÃ§a
enum BillingCycle {
  MONTHLY     /// Mensal
  QUARTERLY   /// Trimestral
  SEMIANNUAL  /// Semestral
  ANNUAL      /// Anual
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”„ SUBSCRIPTION (Ciclo de Vida da Assinatura) - v2.40.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// Status da assinatura
enum SubscriptionStatus {
  TRIALING    /// Em perÃ­odo de trial
  ACTIVE      /// Ativa e em dia
  PAST_DUE    /// Pagamento atrasado (dentro do grace period)
  CANCELED    /// Cancelada por inadimplÃªncia ou pedido
  EXPIRED     /// Expirou (plano anual que terminou)
}

/// Motivo do cancelamento
enum CancellationReason {
  PAYMENT_FAILURE    /// InadimplÃªncia
  CUSTOMER_REQUEST   /// Pedido do cliente
  PLAN_CHANGE        /// MudanÃ§a de plano (downgrade total)
  ADMIN_ACTION       /// AÃ§Ã£o administrativa
}

model Subscription {
  id                    String              @id @default(cuid())

  // Relacionamentos
  clientId              String
  client                Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  planId                String
  plan                  Plan                @relation(fields: [planId], references: [id])

  // Ciclo de billing
  billingCycle          BillingCycle        @default(MONTHLY)
  billingAnchorDay      Int                 /// Dia do mÃªs para cobranÃ§a (1-28)

  // PerÃ­odo atual
  currentPeriodStart    DateTime            @db.Timestamptz
  currentPeriodEnd      DateTime            @db.Timestamptz
  nextBillingDate       DateTime?           @db.Timestamptz

  // Status
  status                SubscriptionStatus  @default(ACTIVE)

  // Grace period
  gracePeriodDays       Int                 @default(7)

  // Cancelamento
  canceledAt            DateTime?           @db.Timestamptz
  cancellationReason    CancellationReason?

  // Valores
  amount                Decimal             @db.Decimal(10, 2)  /// Valor da assinatura

  // Metadados
  metadata              Json?               /// Dados extras flexÃ­veis

  // Timestamps
  createdAt             DateTime            @default(now()) @db.Timestamptz
  updatedAt             DateTime            @updatedAt @db.Timestamptz

  // Payments gerados por esta subscription
  payments              Payment[]

  // Finance transactions vinculadas a esta subscription
  financeTransactions   FinanceTransaction[]  @relation("FinanceTransactions")

  @@index([clientId])
  @@index([status])
  @@index([nextBillingDate])
  @@index([currentPeriodEnd])
}

/// InformaÃ§Ãµes do tenant no sistema destino (One Nexus ou Locadoras)
model Tenant {
  id              String       @id @default(cuid())
  clientId        String       @unique

  // IdentificaÃ§Ã£o
  name            String       /// Nome do tenant (geralmente nome da empresa)
  tenantUuid      String       @unique /// UUID do tenant no sistema destino
  systemUrl       String       /// URL de acesso (ex: cliente.onenexus.com.br)
  vpsLocation     String       /// VPS onde estÃ¡ hospedado (ex: "VPS-29", "VPS-145")

  // Status e mÃ©tricas
  status          TenantStatus @default(ATIVO)
  version         String       @default("1.0.0") /// VersÃ£o do sistema
  lastAccessAt    DateTime?    @db.Timestamptz
  activeUsers     Int          @default(0)
  storageUsedMb   Int          @default(0)

  // MÃ³dulos habilitados (JSON com configuraÃ§Ã£o)
  enabledModules  Json         @default("[]")

  createdAt       DateTime     @default(now()) @db.Timestamptz
  updatedAt       DateTime     @updatedAt @db.Timestamptz

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tenantUuid])
  @@index([status])
}

/// Status do tenant
enum TenantStatus {
  ATIVO       /// Funcionando normalmente
  SUSPENSO    /// Temporariamente suspenso
  BLOQUEADO   /// Bloqueado por inadimplÃªncia
  DELETADO    /// Dados deletados (apÃ³s 120 dias)
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ LEADS E FUNIL DE VENDAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// Leads do funil de vendas
model Lead {
  id              String      @id @default(cuid())

  // Dados do contato
  name            String
  email           String
  phone           String
  companyName     String?     /// Nome da empresa
  cpfCnpj         String?     /// CPF ou CNPJ
  role            ClientRole?
  instagram       String?     /// Instagram (opcional)
  facebook        String?     /// Facebook (opcional)
  city            String?     @db.VarChar(100) /// Cidade - UF (formato: "SÃ£o Paulo - SP")
  numberOfUnits   Int?        /// NÃºmero de unidades da empresa (v2.35.0)

  // Funil
  stageId         String
  originId        String
  interestProduct ProductType @default(ONE_NEXUS)
  interestPlanId  String?

  // AtribuiÃ§Ã£o
  vendedorId      String?

  // Valores e notas
  expectedRevenue Decimal?    @db.Decimal(10, 2) /// Receita mensal esperada (MRR)
  notes           String?     @db.Text /// ObservaÃ§Ãµes sobre o lead

  // MÃ©tricas IA
  score           Int         @default(50) /// Lead Score IA (0-100)
  conversionProb  Decimal?    @db.Decimal(5, 4) /// Probabilidade de conversÃ£o
  estimatedDays   Int?        /// Dias estimados atÃ© conversÃ£o
  discProfile     DISCProfile? /// Perfil DISC identificado pela IA

  // === LEAD SCORE IA (Detalhamento) ===
  aiScoreFactors    Json?       /// Detalhamento dos 6 fatores do score
  aiScoreUpdatedAt  DateTime?   /// Data da Ãºltima atualizaÃ§Ã£o do score

  // Status
  status          LeadStatus  @default(ABERTO)
  lossReasonId    String?
  lossNotes       String?
  convertedAt     DateTime?   @db.Timestamptz /// Data de conversÃ£o em cliente

  // Timestamps
  lastInteractionAt DateTime?   @db.Timestamptz
  createdAt       DateTime    @default(now()) @db.Timestamptz
  updatedAt       DateTime    @updatedAt @db.Timestamptz

  // Relations
  stage             FunnelStage     @relation(fields: [stageId], references: [id])
  origin            LeadOrigin      @relation(fields: [originId], references: [id])
  interestPlan      Plan?           @relation(fields: [interestPlanId], references: [id])
  vendedor          User?           @relation("AssignedVendedor", fields: [vendedorId], references: [id])
  lossReason        LossReason?     @relation(fields: [lossReasonId], references: [id])
  interactions      Interaction[]
  calendarEvents    CalendarEvent[] @relation("LeadCalendarEvents")
  convertedToClient Client?         @relation("ConvertedLead")

  @@index([stageId])
  @@index([originId])
  @@index([vendedorId])
  @@index([status])
  @@index([score])
  @@index([interestProduct])
}

/// Status do lead
enum LeadStatus {
  ABERTO      /// Em andamento no funil
  GANHO       /// Convertido em cliente
  PERDIDO     /// NÃ£o converteu
}

/// Perfil DISC para anÃ¡lise comportamental
enum DISCProfile {
  DOMINANTE   /// D - Direto, decisivo, competitivo
  INFLUENTE   /// I - SociÃ¡vel, entusiasta, otimista
  ESTAVEL     /// S - Paciente, confiÃ¡vel, colaborativo
  CONSCIENTE  /// C - AnalÃ­tico, preciso, sistemÃ¡tico
}

/// EstÃ¡gios do funil de vendas (CRUD configurÃ¡vel)
model FunnelStage {
  id          String   @id @default(cuid())
  name        String
  order       Int      /// Ordem no funil
  color       String   @default("#FF7300") /// Cor para exibiÃ§Ã£o
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leads Lead[]

  @@unique([name])
  @@index([order])
}

/// Origens de leads (CRUD configurÃ¡vel)
model LeadOrigin {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leads Lead[]
}

/// Motivos de perda de leads (CRUD configurÃ¡vel)
model LossReason {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leads Lead[]
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’° FINANCEIRO E PAGAMENTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// Planos de assinatura
model Plan {
  id              String      @id @default(cuid())
  
  // IdentificaÃ§Ã£o
  name            String
  code            String      @unique /// CÃ³digo interno (ex: "ONE_PRO", "LOC_ENTERPRISE")
  product         ProductType
  
  // PreÃ§os
  priceMonthly    Decimal     @db.Decimal(10, 2)
  priceAnnual     Decimal     @db.Decimal(10, 2)
  setupFee        Decimal     @default(0) @db.Decimal(10, 2)
  
  // Limites
  maxUsers        Int         @default(5)
  maxUnits        Int         @default(1)
  storageGb       Int         @default(10)
  
  // MÃ³dulos inclusos (JSON array de Module enum)
  includedModules Json        @default("[]")
  
  // ConfiguraÃ§Ã£o
  isActive        Boolean     @default(true)
  isHighlighted   Boolean     @default(false) /// Destaque na pÃ¡gina de preÃ§os
  sortOrder       Int         @default(0)
  
  createdAt       DateTime    @default(now()) @db.Timestamptz
  updatedAt       DateTime    @updatedAt @db.Timestamptz

  clients         Client[]
  leads           Lead[]
  subscriptions   Subscription[]  /// v2.40.0

  @@index([product])
  @@index([isActive])
}

/// Pagamentos recebidos
model Payment {
  id              String          @id @default(cuid())

  // Relacionamento com Cliente
  clientId        String
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Relacionamento com Subscription (v2.40.0)
  subscriptionId  String?
  subscription    Subscription?   @relation(fields: [subscriptionId], references: [id])

  // Valores
  amount          Decimal         @db.Decimal(10, 2)
  currency        String          @default("BRL")

  // ClassificaÃ§Ã£o
  method          PaymentMethod
  gateway         PaymentGateway  @default(MANUAL)

  // Status
  status          PaymentStatus   @default(PENDING)

  // Gateway externo
  externalId      String?         @unique
  gatewayId       String?         /// ID da transaÃ§Ã£o no gateway
  gatewayData     Json?           /// Dados brutos do webhook

  // Datas importantes (v2.40.0 - Timestamptz)
  dueDate         DateTime?       @db.Timestamptz
  paidAt          DateTime?       @db.Timestamptz
  cancelledAt     DateTime?       @db.Timestamptz
  periodStart     DateTime?       @db.Timestamptz
  periodEnd       DateTime?       @db.Timestamptz

  // DescriÃ§Ã£o
  description     String?         @db.VarChar(500)
  notes           String?         @db.Text

  // Fatura
  invoiceNumber   String?
  invoiceUrl      String?

  // Ciclo de cobranÃ§a (para compatibilidade)
  billingCycle    BillingCycle?

  // Auditoria
  createdById     String?
  createdBy       User?           @relation(fields: [createdById], references: [id])
  createdAt       DateTime        @default(now()) @db.Timestamptz
  updatedAt       DateTime        @updatedAt @db.Timestamptz

  @@index([clientId])
  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@index([paidAt])
  @@index([createdAt])
  @@index([externalId])
  @@index([gateway])
}

/// Gateway de pagamento
enum PaymentGateway {
  ABACATEPAY  /// PIX - Open source
  ASAAS       /// CartÃ£o e boleto
  MANUAL      /// Pagamento manual/transferÃªncia
}

/// Status do pagamento
enum PaymentStatus {
  PENDING     /// Aguardando pagamento
  PROCESSING  /// Processando
  PAID        /// Pago
  OVERDUE     /// Pagamento atrasado
  FAILED      /// Falhou
  REFUNDED    /// Estornado
  CANCELLED   /// Cancelado
}

/// HistÃ³rico de upgrades/downgrades
model UpgradeHistory {
  id            String   @id @default(cuid())
  clientId      String
  
  previousPlan  String   /// Nome do plano anterior
  newPlan       String   /// Nome do novo plano
  previousMrr   Decimal  @db.Decimal(10, 2)
  newMrr        Decimal  @db.Decimal(10, 2)
  reason        String?

  createdAt     DateTime @default(now()) @db.Timestamptz

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([createdAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’¬ INTERAÃ‡Ã•ES E COMUNICAÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// Registro de interaÃ§Ãµes com leads e clientes
model Interaction {
  id          String          @id @default(cuid())
  
  // ReferÃªncia (lead OU cliente)
  leadId      String?
  clientId    String?
  userId      String          /// Quem registrou
  
  // ConteÃºdo
  type        InteractionType
  title       String
  content     String          @db.Text
  
  createdAt   DateTime        @default(now())

  lead    Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client  Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([clientId])
  @@index([userId])
  @@index([createdAt])
}

/// Tipo de interaÃ§Ã£o
enum InteractionType {
  CALL          /// LigaÃ§Ã£o
  EMAIL         /// E-mail
  WHATSAPP      /// WhatsApp
  MEETING       /// ReuniÃ£o
  DEMO          /// DemonstraÃ§Ã£o
  NOTE          /// AnotaÃ§Ã£o interna
  SUPPORT       /// Suporte
  PROPOSAL      /// Proposta enviada
}

/// Conversas de chat (preparado para Chatwoot)
model ChatConversation {
  id              String    @id @default(cuid())
  clientId        String
  externalId      String?   @unique /// ID no Chatwoot
  
  status          ChatStatus @default(OPEN)
  channel         ChatChannel @default(WHATSAPP)
  
  lastMessageAt   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  client   Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([clientId])
  @@index([status])
}

/// Mensagens de chat
model ChatMessage {
  id              String    @id @default(cuid())
  conversationId  String
  senderId        String?   /// null = mensagem do cliente
  
  content         String    @db.Text
  contentType     String    @default("text") /// text, image, file, etc
  
  isFromClient    Boolean   @default(false)
  readAt          DateTime?
  
  createdAt       DateTime  @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?            @relation("SentMessages", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

/// Status da conversa
enum ChatStatus {
  OPEN        /// Aberta
  PENDING     /// Aguardando resposta
  RESOLVED    /// Resolvida
  CLOSED      /// Fechada
}

/// Canal de chat
enum ChatChannel {
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  EMAIL
  WEB
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“… CALENDÃRIO E EVENTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// Eventos do calendÃ¡rio
model CalendarEvent {
  id            String        @id @default(cuid())
  userId        String        /// Dono do evento

  title         String
  description   String?       @db.Text
  type          EventType

  // Datas (v2.40.0 - Timestamptz)
  startAt       DateTime      @db.Timestamptz
  endAt         DateTime      @db.Timestamptz
  isAllDay      Boolean       @default(false)

  // Participantes
  attendeesCount Int          @default(1)

  // Local
  location      String?
  meetingUrl    String?       /// Link para reuniÃ£o online

  // ReferÃªncia (opcional)
  leadId        String?
  clientId      String?

  // Lembretes
  reminderMinutes Int[]       @default([30]) /// Minutos antes para lembrar

  // Eventos recorrentes
  isRecurring     Boolean       @default(false)
  recurrenceRule  String?       /// RRULE format (RFC 5545)
  recurrenceEnd   DateTime?     @db.Timestamptz /// Data final da recorrÃªncia
  parentEventId   String?       /// Evento pai (para exceÃ§Ãµes)
  exceptionDates  DateTime[]    @default([]) /// Datas excluÃ­das da recorrÃªncia

  // IntegraÃ§Ã£o Google Calendar
  googleEventId    String?       @unique
  googleCalendarId String?       @default("primary") /// ID do calendÃ¡rio no Google
  googleSyncStatus String?       @default("SYNCED") /// SYNCED, PENDING, ERROR
  googleLastSync   DateTime?     @db.Timestamptz /// Ãšltima sincronizaÃ§Ã£o

  // Soft delete
  deletedAt        DateTime?    @db.Timestamptz

  createdAt     DateTime      @default(now()) @db.Timestamptz
  updatedAt     DateTime      @updatedAt @db.Timestamptz

  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead         Lead?           @relation("LeadCalendarEvents", fields: [leadId], references: [id], onDelete: SetNull)
  client       Client?         @relation("ClientCalendarEvents", fields: [clientId], references: [id], onDelete: SetNull)
  parentEvent  CalendarEvent?  @relation("RecurringEvents", fields: [parentEventId], references: [id], onDelete: Cascade)
  childEvents  CalendarEvent[] @relation("RecurringEvents")

  @@index([userId])
  @@index([leadId])
  @@index([clientId])
  @@index([startAt])
  @@index([type])
  @@index([parentEventId])
  @@index([isRecurring])
  @@index([deletedAt])
}

/// Tipo de evento
enum EventType {
  DEMO          /// DemonstraÃ§Ã£o
  MEETING       /// ReuniÃ£o
  CALL          /// LigaÃ§Ã£o
  FOLLOWUP      /// Follow-up
  SUPPORT       /// Suporte
  INTERNAL      /// Evento interno
}

/// Tokens OAuth2 do Google Calendar
model GoogleCalendarToken {
  id              String    @id @default(cuid())
  userId          String    @unique

  // Tokens criptografados (AES-256-GCM)
  accessToken     String    @db.Text
  refreshToken    String    @db.Text
  expiresAt       DateTime

  // Metadados
  scope           String    /// Escopos concedidos
  calendarId      String    @default("primary") /// ID do calendÃ¡rio no Google

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”” NOTIFICAÃ‡Ã•ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// NotificaÃ§Ãµes do sistema
model Notification {
  id          String            @id @default(cuid())
  userId      String
  
  type        NotificationType
  title       String
  message     String
  link        String?           /// Link para aÃ§Ã£o
  
  // Dados extras (JSON flexÃ­vel)
  metadata    Json?
  
  isRead      Boolean           @default(false)
  readAt      DateTime?
  
  createdAt   DateTime          @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

/// Tipo de notificaÃ§Ã£o
enum NotificationType {
  // IA Preditiva
  AI_CHURN_ALERT        /// Alerta de risco de churn
  AI_OPPORTUNITY        /// Oportunidade detectada pela IA
  AI_LEAD_SCORE         /// Lead com score alto
  
  // Financeiro
  PAYMENT_RECEIVED      /// Pagamento recebido
  PAYMENT_OVERDUE       /// Pagamento em atraso
  SUBSCRIPTION_EXPIRING /// Assinatura prestes a vencer
  
  // Leads
  NEW_LEAD              /// Novo lead
  LEAD_ASSIGNED         /// Lead atribuÃ­do
  LEAD_CONVERTED        /// Lead convertido
  
  // Sistema
  SYSTEM_UPDATE         /// AtualizaÃ§Ã£o do sistema
  SYSTEM_ALERT          /// Alerta do sistema
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¤– INTELIGÃŠNCIA ARTIFICIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// Conversas com o Nexus Sales AI
model AIConversation {
  id          String      @id @default(cuid())
  userId      String
  
  // Contexto
  contextType AIContextType
  contextId   String?     /// ID do lead ou cliente
  
  title       String?
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AIMessage[]

  @@index([userId])
  @@index([contextType])
}

/// Mensagens da conversa com IA
model AIMessage {
  id              String    @id @default(cuid())
  conversationId  String
  
  role            AIRole
  content         String    @db.Text
  
  // Metadados
  model           String?   /// Modelo usado (gemini, openrouter, etc)
  tokensUsed      Int?
  
  createdAt       DateTime  @default(now())

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

/// Tipo de contexto para IA
enum AIContextType {
  LEAD      /// Conversa sobre um lead especÃ­fico
  CLIENT    /// Conversa sobre um cliente
  GENERAL   /// Conversa geral
}

/// Role na conversa
enum AIRole {
  USER
  ASSISTANT
  SYSTEM
}

/// AnÃ¡lises geradas pela IA (batch diÃ¡rio)
model AIAnalysis {
  id          String          @id @default(cuid())
  
  type        AIAnalysisType
  targetType  String          /// "lead" ou "client"
  targetId    String
  
  // Resultado da anÃ¡lise (JSON flexÃ­vel)
  result      Json
  confidence  Decimal         @db.Decimal(5, 4) /// ConfianÃ§a (0-1)
  
  // Rastreabilidade
  model       String          /// Modelo usado
  promptHash  String?         /// Hash do prompt para cache
  
  createdAt   DateTime        @default(now())

  @@index([targetType, targetId])
  @@index([type])
  @@index([createdAt])
}

/// Tipos de anÃ¡lise IA
enum AIAnalysisType {
  // AnÃ¡lises de Cliente
  CHURN_PREDICTION      /// PrevisÃ£o de churn
  HEALTH_SCORE          /// Score de saÃºde
  UPSELL_OPPORTUNITY    /// Oportunidade de upsell
  
  // AnÃ¡lises de Lead
  LEAD_SCORING          /// Lead scoring
  CONVERSION_PREDICTION /// PrevisÃ£o de conversÃ£o
  DISC_PROFILE          /// AnÃ¡lise de perfil DISC
  
  // AnÃ¡lises Financeiras
  REVENUE_FORECAST      /// PrevisÃ£o de receita
  CASH_FLOW_PREDICTION  /// PrevisÃ£o de cash flow
  ANOMALY_DETECTION     /// DetecÃ§Ã£o de anomalias
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ AUDITORIA E LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// Log de impersonate (auditoria obrigatÃ³ria - NÃƒO DELETÃVEL)
model ImpersonateLog {
  id          String    @id @default(cuid())
  userId      String    /// Quem fez o impersonate
  clientId    String    /// Cliente acessado
  tenantId    String    /// Tenant acessado
  
  reason      String    /// Motivo obrigatÃ³rio
  ipAddress   String
  userAgent   String?
  
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  
  // AÃ§Ãµes realizadas durante o impersonate (opcional)
  actions     Json?

  user   User   @relation(fields: [userId], references: [id])
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // onDelete: Cascade - logs deletados junto com o cliente (v2.39.2)
  @@index([userId])
  @@index([clientId])
  @@index([startedAt])
}

/// Log de aÃ§Ãµes do sistema (auditoria geral)
model AuditLog {
  id          String    @id @default(cuid())
  userId      String?   /// null = sistema
  clientId    String?   /// Cliente relacionado (se aplicÃ¡vel)

  action      String    /// CREATE, UPDATE, DELETE, etc
  entity      String    /// Nome da entidade
  entityId    String    /// ID da entidade

  // Dados da mudanÃ§a
  oldData     Json?
  newData     Json?

  ipAddress   String?
  userAgent   String?

  createdAt   DateTime  @default(now())

  user   User?   @relation(fields: [userId], references: [id])
  client Client? @relation(fields: [clientId], references: [id])

  @@index([userId])
  @@index([clientId])
  @@index([entity, entityId])
  @@index([action])
  @@index([createdAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ CONFIGURAÃ‡Ã•ES DO SISTEMA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// ConfiguraÃ§Ãµes gerais do sistema
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

/// IntegraÃ§Ãµes configuradas
model Integration {
  id          String            @id @default(cuid())
  name        String            @unique
  type        IntegrationType
  
  // ConfiguraÃ§Ã£o (JSON flexÃ­vel - NUNCA armazenar secrets aqui!)
  config      Json              @default("{}")
  
  isActive    Boolean           @default(false)
  lastSyncAt  DateTime?
  lastError   String?
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

/// Tipos de integraÃ§Ã£o
enum IntegrationType {
  PAYMENT_GATEWAY   /// AbacatePay, Asaas
  EMAIL             /// SMTP Zoho
  AI_PROVIDER       /// Groq, Gemini, OpenRouter
  CHAT              /// Chatwoot, WAHA
  CALENDAR          /// Google Calendar
  ANALYTICS         /// Google Ads, Meta Ads
}

/// Webhooks recebidos (para idempotÃªncia)
model WebhookEvent {
  id            String    @id @default(cuid())
  source        String    /// "abacatepay", "asaas", etc
  externalId    String    /// ID Ãºnico do evento no sistema externo
  eventType     String    /// Tipo do evento
  
  payload       Json      /// Payload completo
  processedAt   DateTime?
  error         String?
  
  createdAt     DateTime  @default(now())

  @@unique([source, externalId])
  @@index([source])
  @@index([eventType])
  @@index([createdAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’° MÃ“DULO FINANCEIRO - GESTOR NEXUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model FinanceTransaction {
  id              String                    @id @default(cuid())

  // Dados bÃ¡sicos (igual protÃ³tipo linha 32-37)
  description     String                    @db.VarChar(300)
  amount          Decimal                   @db.Decimal(12, 2)
  type            FinanceTransactionType    // INCOME ou EXPENSE
  category        FinanceCategory           // Assinatura, Setup, etc

  // Datas
  date            DateTime                  @db.Date
  dueDate         DateTime?                 @db.Date
  paidAt          DateTime?

  // Status (igual protÃ³tipo: Pago, Pendente, Vencido)
  status          FinanceStatus             @default(PENDING)

  // Cliente (opcional - pode ser transaÃ§Ã£o avulsa)
  clientId        String?
  client          Client?                   @relation(fields: [clientId], references: [id])

  // Assinatura (opcional - vincula transaÃ§Ã£o a ciclo de billing)
  subscriptionId  String?
  subscription    Subscription?             @relation("FinanceTransactions", fields: [subscriptionId], references: [id], onDelete: SetNull)

  // Produto (opcional - para transaÃ§Ãµes sem cliente ou override)
  productType     ProductType?

  // MRR tracking
  isRecurring     Boolean                   @default(false)

  // Auditoria
  createdBy       String
  creator         User                      @relation("FinanceCreator", fields: [createdBy], references: [id])
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([clientId])
  @@index([date])
  @@index([status])
  @@index([category])
  @@index([productType])
  @@index([subscriptionId])
  @@map("finance_transactions")
}

enum FinanceTransactionType {
  INCOME
  EXPENSE
}

enum FinanceCategory {
  SUBSCRIPTION  // Assinatura (MRR)
  SETUP         // Setup/ImplantaÃ§Ã£o
  SUPPORT       // Suporte
  CONSULTING    // Consultoria
  OTHER         // Outros
}

enum FinanceStatus {
  PAID      // Pago
  PENDING   // Pendente
  OVERDUE   // Vencido
  CANCELLED // Cancelado
}
